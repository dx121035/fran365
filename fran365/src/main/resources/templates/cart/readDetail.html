<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout=http:www.ultraq.net.nz/thymeleaf/layout
      layout:decorate="~{fragments/layout1}">

<div layout:fragment="content">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- PortOne SDK -->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>


    <script>
        var IMP = window.IMP;
        IMP.init("imp50853832");

        function requestPay() {
            console.log(uuid());
            if([[${itemSize}]] == 0){
                item = "[[${itemName}]]"
            } else {
                item = "[[${itemName}]] 외 [[${itemSize}]]개"
            }
            IMP.request_pay(
                {
                    pg: "danal_tpay",
                    pay_method: "card",
                    merchant_uid: "ORD"+uuid(),
                    name: item,
                    amount: "[[${total}]]",
                    buyer_email: "[[${member.username}]]"

                },
                function (rsp) {

                    if(rsp.success) { //결제 성공 케이스
                        alert("카드 결제 성공")
                        //컨트롤러로 성공시 성공 ID값 전달
                        location.href='/delivery/pay?uid=' + rsp.imp_uid;

                    } else { //결제 실패 케이스
                        alert("카드 결제 실패")
                    }

                }
            );
        }
    </script>
    <script>
        function uuid() {
            return 'xxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        console.log(uuid())
    </script>


    <!-- ============================================-->
    <!-- <section> begin ============================-->
    <section class="pt-5 pb-9">
        <div class="container-small cart">
            <h2 class="mb-6">장바구니</h2>
            <div class="row g-5">
                <div class="col-12 col-lg-8">
                    <div id="cartTable" data-list='{"valueNames":["name","price","createDate","quantity","total"],"page":10}'>
                        <div class="table-responsive scrollbar mx-n1 px-1">
                            <table class="table fs--1 mb-0 border-top border-200">
                                <thead>
                                <tr>
                                    <th class="sort white-space-nowrap align-middle fs--2" scope="col"></th>
                                    <th class="sort white-space-nowrap align-middle" scope="col" style="min-width:250px;">제품명</th>
                                    <th class="sort align-middle text-end" scope="col" style="width:300px;">가격</th>
                                    <th class="sort align-middle ps-5 text-center" scope="col" style="width:200px;">수량</th>
                                    <th class="sort align-middle text-end" scope="col" style="width:250px;">합계</th>
                                    <th class="sort text-end align-middle pe-0" scope="col"></th>
                                </tr>
                                </thead>
                                <tbody class="list" id="cart-table-body">
                                <th:block th:each="item : ${cart.itemList}">
                                    <tr class="cart-table-row btn-reveal-trigger">
                                        <td class="align-middle white-space-nowrap py-0"><img th:src="@{|${awspath}/${item.image}|}" alt="" width="53" height="53" class ="d-block border rounded-2"/></td>
                                        <td class="products align-middle">[[${item.name}]]</td>
                                        <td class="price align-middle text-900 fs--1 fw-semi-bold text-end">[[${item.price}]]</td>
                                        <td class="quantity align-middle fs-0 ps-5">
                                            <div class="quantity input-group input-group-sm flex-nowrap" data-quantity="data-quantity" th:value="${item.quantity}" th:attr="data-id=${item.id}">





                                                <button class="btn btn-sm px-2" data-type="minus">-</button>
                                                <input class="quantity form-control text-center input-spin-none bg-transparent border-0 px-0" type="number" name="quantity" min="1" value="1" th:value="${item.quantity}" th:attr="data-id=${item.id}"/>
                                                <button class="btn btn-sm px-2" data-type="plus">+</button>





                                            </div>
                                        </td>
                                        <td class="align-middle fw-bold text-1000 text-end">$398</td>
                                        <td class="align-middle white-space-nowrap text-end pe-0 ps-3">
                                            <button class="delete btn btn-sm text-500 hover-text-600 me-2" th:attr="data-id=${item.id}"><span class="fas fa-trash"></span></button>
                                        </td>
                                    </tr>
                                </th:block>

                                <tr class="cart-table-row btn-reveal-trigger">
                                    <td class="text-1100 fw-semi-bold ps-0 fs-0" colspan="6">상품 금액 :</td>
                                    <td class="total text-1100 fw-bold text-end fs-0">원</td>
                                    <td></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex flex-between-center mb-3">
                                <h3 class="card-title mb-0">Summary</h3><a class="btn btn-link p-0" href="#!">Edit cart </a>
                            </div>
                            <select class="form-select mb-3" aria-label="delivery type">
                                <option value="cod">Cash on Delivery</option>
                                <option value="card">Card</option>
                                <option value="paypal">Paypal</option>
                            </select>
                            <div>
                                <div class="d-flex justify-content-between">
                                    <p class="text-900 fw-semi-bold">상품 금액 :</p>
                                    <p class="total text-1100 fw-semi-bold">원</p>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <p class="text-900 fw-semi-bold">Discount :</p>
                                    <p class="text-danger fw-semi-bold">-$59</p>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <p class="text-900 fw-semi-bold">Tax :</p>
                                    <p class="text-1100 fw-semi-bold">$126.20</p>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <p class="text-900 fw-semi-bold">Subtotal :</p>
                                    <p class="text-1100 fw-semi-bold">$665</p>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <p class="text-900 fw-semi-bold">배송비 :</p>
                                    <p class="text-1100 fw-semi-bold">$30</p>
                                </div>
                            </div>
                            <div class="input-group mb-3">
                                <input class="form-control" type="text" placeholder="Voucher" />
                                <button class="btn btn-phoenix-primary px-5">Apply</button>
                            </div>
                            <div class="d-flex justify-content-between border-y border-dashed py-3 mb-4">
                                <h4 class="mb-0">총 금액 :</h4>
                                <h4 class="mb-">$695.20</h4>
                            </div>
                            <button class="btn btn-primary w-100" onclick="requestPay()">결제하기<span class="fas fa-chevron-right ms-1 fs--2"></span></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- end of .container-->
    </section>


    <div class="size-209">
								<span class="total">
									[[${total}]]원
								</span>
    </div>

    <button onclick="requestPay()">결제하기</button>









    <script>
        // jQuery document ready function
        $(document).ready(function () {
            // Event listener for minus button
            $('button[data-type="minus"]').click(function () {
                // Get the input element
                var inputElement = $(this).next('input');

                // Get the current value
                var currentValue = parseInt(inputElement.val());

                // Update the value if greater than the minimum
                if (currentValue > inputElement.attr('min')) {
                    inputElement.val(currentValue - 1);
                }
            });

            // Event listener for plus button
            $('button[data-type="plus"]').click(function () {
                // Get the input element
                var inputElement = $(this).prev('input');

                // Get the current value
                var currentValue = parseInt(inputElement.val());

                // Update the value
                inputElement.val(currentValue + 1);
            });
        });
    </script>

    <script>


        $(".quantity").change(function() {
            var itemId = $(this).data("id");
            var quantity = $(this).val();

            alert("itemId");
            alert("quantity");
            $.ajax({
                type: "POST",
                url: "/cart/update",
                dataType: "json",
                data: {
                    itemId: itemId,
                    quantity: quantity
                },
                success: function(data) {
                    // 총합 금액 업데이트
                    $(".total").text(data.total + "원");
                },
                error: function(err) {
                    // 에러 처리
                    console.log(err);
                }
            });
        });

        $(".delete").click(function() {

            var itemId = $(this).data("id");

            $.ajax({
                type: "POST",
                url: "/cart/delete",
                data: {
                    itemId: itemId
                },
                success: function() {
                        $("button[data-id='" + itemId + "']").parent().remove();
                        location.reload();
                },
                error: function(err) {
                    console.log(err);
                }
            });
        });


    </script>
</div>
